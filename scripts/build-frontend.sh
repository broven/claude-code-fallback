#!/bin/bash
set -e

echo "Building frontend..."
cd "$(dirname "$0")/../frontend"
npx vite build

echo "Embedding frontend into worker..."
HTML_CONTENT=$(cat dist/index.html)

# Write as a TypeScript module
cat > ../src/admin-html.ts << 'HEADER'
// Auto-generated by scripts/build-frontend.sh
// Do not edit manually
export const ADMIN_HTML =
HEADER

# Append the HTML as a template literal
echo -n '`' >> ../src/admin-html.ts

# Escape for TypeScript template literal:
# 1. Backslashes \ -> \\ (must be first!)
# 2. Backticks ` -> \`
# 3. Template expressions ${ -> \${
sed 's/\\/\\\\/g; s/`/\\`/g; s/\${/\\${/g' dist/index.html >> ../src/admin-html.ts

echo '`;' >> ../src/admin-html.ts

echo "Frontend embedded into src/admin-html.ts"
